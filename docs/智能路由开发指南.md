# 智能路由系统开发指南

## 🎯 概述
智能路由系统可以为不同的文献源提供针对性的快速处理路径。本文档说明如何为新的文献源添加适配器和配置路由。

## 🔧 添加新文献源的完整流程

### 1️⃣ 第一步：创建URL适配器（如需要）
**位置**：`literature_parser_backend/services/url_mapping/adapters/`

```python
# 示例：为新期刊 "Nature" 创建适配器
class NatureAdapter(URLAdapter):
    def can_handle(self, url: str) -> bool:
        return 'nature.com' in url.lower()
    
    def extract_identifiers(self, url: str) -> URLMappingResult:
        # 提取DOI、标题、作者等信息
        return URLMappingResult(
            doi=extracted_doi,
            title=extracted_title,
            authors=extracted_authors,
            venue="Nature"
        )
```

### 2️⃣ 第二步：创建元数据处理器（如需要）
**位置**：`literature_parser_backend/worker/metadata/processors/`

```python
# 示例：创建Nature专用处理器
class NatureProcessor(MetadataProcessor):
    @property
    def name(self) -> str:
        return "Nature Specialized"
    
    def can_handle(self, identifier_data: IdentifierData) -> bool:
        return identifier_data.venue == "Nature" and identifier_data.doi
    
    async def process(self, identifier_data: IdentifierData) -> MetadataResult:
        # 使用Nature的API或页面解析获取元数据
        pass
```

**📝 重要：处理器必须在 `__init__.py` 中注册：**
```python
# literature_parser_backend/worker/metadata/processors/__init__.py
from .nature import NatureProcessor
registry.register(NatureProcessor)
```

### 3️⃣ 第三步：配置智能路由
**位置**：`literature_parser_backend/worker/execution/routing.py`

```python
# 在 _load_builtin_routes() 方法中添加新路由
Route(
    name="nature_fast_path",
    patterns=["nature.com/articles", "nature.com/nature"],
    processors=["Nature Specialized", "CrossRef"],  # 使用准确的处理器名称
    priority=2  # 数字越小优先级越高
)
```

### 4️⃣ 第四步：更新快速路径判断（已废弃，现在只要注册即自动判断）
**位置**：`literature_parser_backend/worker/tasks.py`

```python
# 在 should_use_smart_routing() 函数中添加新模式
fast_patterns = [
    'arxiv.org/abs',
    'proceedings.neurips.cc',
    'nature.com/articles',  # 新增
    # ...
]
```

## 🎮 不同场景的配置策略

### 📰 高置信度源（如ArXiv）
```python
Route(
    name="arxiv_fast_path",
    patterns=["arxiv.org/abs", "arxiv.org/pdf"],
    processors=["Semantic Scholar"],  # 单个高效处理器
    priority=1  # 最高优先级
)
```

### 🏛️ 需要增强处理的源（如会议网站）
```python
Route(
    name="neurips_enhanced_path", 
    patterns=["proceedings.neurips.cc"],
    processors=["CrossRef"],  # 使用精确搜索
    priority=2
)
```

### 🌐 通用回退路径
```python
Route(
    name="standard_waterfall",
    patterns=["*"],  # 匹配所有其他URL
    processors=["Semantic Scholar", "CrossRef", "Site Parser V2"],  # 多处理器并行
    priority=10  # 最低优先级
)
```

## 🚀 路由系统工作原理

### 执行流程
1. **URL映射** → 提取基础标识符（DOI、标题等）
2. **路由决策** → 根据URL模式选择最优路由
3. **智能执行** → 并行或序列执行处理器
4. **Hook处理** → 自动去重、别名创建、质量评估
5. **结果返回** → 或回退到传统瀑布流

### 路由优先级
- `priority=1` → 最高优先级（快速路径）
- `priority=2-5` → 中等优先级（增强路径）  
- `priority=10` → 最低优先级（通用回退）

## 🎯 处理器选择逻辑

### 快速路径 (`*_fast_path`)
- 只执行第一个可用处理器
- 适合高置信度源（ArXiv、DOI直链）
- 追求极致速度

### 标准路径 (`*_waterfall`) 
- 并行执行多个处理器
- 选择置信度最高的结果
- 保证成功率

## 🔍 调试和验证

### 查看路由决策日志
```bash
sudo docker compose logs worker | grep "URL路由决策"
```

### 测试新适配器
```python
# 在测试文件中验证
python3 test_various_links.py
```

### 检查处理器注册
```python
# 查看已注册的处理器
from literature_parser_backend.worker.metadata.registry import get_global_registry
registry = get_global_registry()
print(registry.get_available_processors())
```

## ⚠️ 注意事项

1. **处理器名称必须精确匹配**：路由配置中的处理器名称必须与处理器类的 `name` 属性完全一致

2. **优先级设计**：数字越小优先级越高，避免冲突

3. **URL模式匹配**：使用子字符串匹配，确保模式足够具体

4. **Hook系统自动触发**：无需手动配置，会自动处理去重和别名

5. **回退机制**：智能路由失败时会自动回退到传统瀑布流

## 📋 快速检查清单

- [ ] URL适配器能正确提取标识符
- [ ] 元数据处理器已注册且 `can_handle()` 逻辑正确
- [ ] 路由配置中的处理器名称精确匹配
- [ ] 路由优先级设置合理
- [ ] 测试验证功能正常

---

**🎉 添加新文献源就是这么简单！大多数情况下只需要修改路由配置即可复用现有处理器。**
